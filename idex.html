<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secured Tabbed Browser Concept</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* Style for the iframe to ensure it fills its container */
        .tab-content {
            width: 100%;
            height: calc(100vh - 120px); /* Adjust based on header/tab bar height */
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .browser-iframe {
            width: 100%;
            height: 100%;
            border: none;
            transition: width 0.3s ease-in-out;
        }
        /* Custom scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header / Auth Status Bar -->
        <header class="bg-indigo-700 text-white shadow-lg p-3 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-bold flex items-center">
                <i data-lucide="lock" class="w-6 h-6 mr-2"></i>
                Secured Browser UI
            </h1>
            <div id="auth-info" class="flex items-center space-x-3">
                <!-- Content will be populated by JavaScript -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 space-y-4">

            <!-- Authentication Modal Overlay (Initially Hidden) -->
            <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center hidden">
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign In / Sign Up</h2>
                    
                    <div id="auth-error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>

                    <!-- Email/Password Form -->
                    <div class="space-y-4">
                        <input id="email-input" type="email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input id="password-input" type="password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        
                        <div class="flex space-x-3">
                            <button onclick="handleEmailAuth(true)" class="flex-1 bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                Sign In
                            </button>
                            <button onclick="handleEmailAuth(false)" class="flex-1 bg-gray-500 text-white font-semibold py-3 rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                                Sign Up
                            </button>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div class="relative flex py-5 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-500">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <!-- Google Sign-In -->
                    <button onclick="signInWithGoogle()" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md flex items-center justify-center">
                        <i data-lucide="external-link" class="w-5 h-5 mr-3"></i>
                        Sign In with Google
                    </button>
                </div>
            </div>

            <!-- Browser UI (Only visible when authenticated) -->
            <div id="browser-ui" class="hidden">
                
                <!-- Tab Bar and Controls -->
                <div class="flex items-center bg-white p-2 rounded-t-xl shadow-lg border-b-2 border-indigo-100">
                    <div id="tab-bar" class="flex flex-grow overflow-x-auto whitespace-nowrap space-x-1">
                        <!-- Tabs will be dynamically added here -->
                    </div>
                    <button id="add-tab-btn" onclick="addTab('https://www.google.com')" class="bg-indigo-500 text-white p-2 ml-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md flex items-center justify-center flex-shrink-0">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- URL Bar and Settings -->
                <div class="bg-gray-100 p-3 rounded-b-xl shadow-inner flex items-center space-x-3 mb-4">
                    <input id="url-input" type="text" placeholder="Enter URL (e.g., https://www.google.com)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button onclick="loadCurrentTab()" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>

                    <!-- Desktop Mode Toggle -->
                    <div class="flex items-center space-x-2 p-2 bg-indigo-100 rounded-lg shadow-inner">
                        <input type="checkbox" id="desktop-mode-toggle" onchange="toggleDesktopMode()" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="desktop-mode-toggle" class="text-sm font-medium text-indigo-700 whitespace-nowrap">Desktop View*</label>
                    </div>
                </div>

                <!-- Content Area -->
                <div id="tab-content-container" class="tab-content relative p-2 overflow-hidden">
                    <!-- IFrames will be added here -->
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center items-center py-12 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="ml-4 text-lg text-indigo-600">Loading...</p>
            </div>

            <!-- Footer for explanation -->
            <div id="browser-footer" class="text-center text-sm text-gray-500 mt-6 pt-4 border-t border-gray-200 hidden">
                <p>*The "Desktop View" feature resizes the frame to a wide desktop resolution, but due to browser security policies, it cannot change the User Agent seen by external websites.</p>
                <p class="mt-2 text-xs">**Note: Due to security restrictions (X-Frame-Options/CORS), many major websites like Google or Twitter may refuse to load in an iframe.</p>
            </div>

        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level for debugging
        setLogLevel('debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let tabs = [];
        let activeTabIndex = 0;

        // --- Core UI Elements ---
        const authModal = document.getElementById('auth-modal');
        const browserUI = document.getElementById('browser-ui');
        const authInfo = document.getElementById('auth-info');
        const loadingIndicator = document.getElementById('loading-indicator');
        const tabBar = document.getElementById('tab-bar');
        const tabContentContainer = document.getElementById('tab-content-container');
        const urlInput = document.getElementById('url-input');
        const errorMessageDiv = document.getElementById('auth-error-message');
        const browserFooter = document.getElementById('browser-footer');

        // Helper to display errors
        function displayAuthError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            setTimeout(() => errorMessageDiv.classList.add('hidden'), 5000);
        }

        // --- Authentication Functions ---

        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                authInfo.innerHTML = `
                    <span class="text-sm font-medium hidden sm:inline-block">${user.email ? user.email : 'Anonymous User'}</span>
                    <button id="sign-out-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-1 px-3 rounded-lg transition duration-150 shadow-md">
                        <i data-lucide="log-out" class="w-4 h-4 inline-block mr-1"></i>Sign Out
                    </button>
                `;
                browserUI.classList.remove('hidden');
                browserFooter.classList.remove('hidden');
                authModal.classList.add('hidden');
                
                // Re-render lucide icons
                lucide.createIcons();

                document.getElementById('sign-out-btn').onclick = handleSignOut;

                // Initialize Tabs only if first time logging in or after signing out/in
                if (tabs.length === 0) {
                    addTab('https://www.google.com'); // Default starting page
                }
            } else {
                currentUserId = null;
                authInfo.innerHTML = `
                    <button onclick="showAuthModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-1 px-3 rounded-lg transition duration-150 shadow-md">
                        Sign In / Sign Up
                    </button>
                `;
                browserUI.classList.add('hidden');
                browserFooter.classList.add('hidden');
                showAuthModal(); // Force modal visibility if not signed in
            }
        });

        window.showAuthModal = () => {
            authModal.classList.remove('hidden');
        }

        window.handleSignOut = async () => {
            try {
                await signOut(auth);
                tabs = []; // Clear tabs on sign out
                tabBar.innerHTML = '';
                tabContentContainer.innerHTML = '';
                urlInput.value = '';
                activeTabIndex = 0;
            } catch (error) {
                console.error("Sign out error:", error);
                displayAuthError("Sign out failed. Please try again.");
            }
        };

        window.signInWithGoogle = async () => {
            loadingIndicator.classList.remove('hidden');
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in error:", error);
                const message = error.message || "Google Sign-In failed.";
                displayAuthError(message);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        window.handleEmailAuth = async (isSignIn) => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            
            if (!email || !password) {
                return displayAuthError("Email and Password are required.");
            }

            loadingIndicator.classList.remove('hidden');

            try {
                if (isSignIn) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Email auth error:", error);
                let msg = "Authentication failed.";
                if (error.code === 'auth/weak-password') {
                    msg = "Password should be at least 6 characters.";
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = "Email already in use. Try signing in.";
                } else if (error.code === 'auth/invalid-credential') {
                    msg = "Invalid email or password.";
                } else if (error.code === 'auth/user-not-found') {
                    msg = "User not found. Try signing up.";
                }
                displayAuthError(msg);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        // --- Tab Management Functions ---

        function renderTabs() {
            tabBar.innerHTML = '';
            tabContentContainer.innerHTML = '';

            tabs.forEach((tab, index) => {
                // 1. Render Tab Button
                const isActive = index === activeTabIndex;
                const tabButton = document.createElement('button');
                tabButton.className = `flex items-center space-x-2 py-2 px-3 rounded-lg text-sm font-medium transition duration-150 ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                tabButton.onclick = () => activateTab(index);

                const tabTitle = document.createElement('span');
                tabTitle.textContent = tab.url.replace(/^https?:\/\//, '').split('/')[0] || 'New Tab';
                tabTitle.className = 'max-w-xs overflow-hidden truncate';
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = `<i data-lucide="x" class="w-4 h-4 ml-1"></i>`;
                closeButton.className = 'p-1 hover:bg-opacity-80 rounded-full';
                closeButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent activating the tab when closing
                    removeTab(index);
                };
                
                tabButton.appendChild(tabTitle);
                tabButton.appendChild(closeButton);
                tabBar.appendChild(tabButton);

                // 2. Render Iframe Content
                const iframe = document.createElement('iframe');
                iframe.src = tab.url;
                iframe.id = `iframe-${index}`;
                iframe.className = `browser-iframe ${isActive ? '' : 'hidden'}`;
                iframe.onload = () => {
                    // This is a placeholder for getting a real title, which is often blocked by CORS
                    // console.log(`Tab ${index} loaded: ${iframe.contentDocument.title}`);
                };

                tabContentContainer.appendChild(iframe);
            });
            
            // Re-render lucide icons
            lucide.createIcons();
            
            // Update URL input for the active tab
            if (tabs[activeTabIndex]) {
                urlInput.value = tabs[activeTabIndex].url;
                
                // Apply desktop mode if enabled
                const isDesktop = document.getElementById('desktop-mode-toggle').checked;
                toggleDesktopMode(isDesktop);
            } else {
                urlInput.value = '';
            }
        }

        window.addTab = (url = 'about:blank') => {
            tabs.push({ url: url });
            activeTabIndex = tabs.length - 1;
            renderTabs();
        };

        function activateTab(index) {
            activeTabIndex = index;
            renderTabs();
        }

        function removeTab(index) {
            tabs.splice(index, 1);
            
            if (tabs.length === 0) {
                // If the last tab is closed, add a new default one
                addTab('https://www.google.com');
            } else {
                // If the removed tab was the active one, activate the new adjacent one
                if (activeTabIndex > index) {
                    activeTabIndex--;
                } else if (activeTabIndex === index) {
                    activeTabIndex = Math.min(index, tabs.length - 1);
                }
                renderTabs();
            }
        }

        window.loadCurrentTab = () => {
            const url = urlInput.value.trim();
            if (url && tabs[activeTabIndex]) {
                // Prepend protocol if missing
                const formattedUrl = url.startsWith('http') ? url : `https://${url}`;
                tabs[activeTabIndex].url = formattedUrl;
                renderTabs();
            }
        };
        
        // --- Desktop Mode Logic ---
        window.toggleDesktopMode = (forceState = null) => {
            const toggle = document.getElementById('desktop-mode-toggle');
            const isDesktop = forceState !== null ? forceState : toggle.checked;

            const iframe = document.getElementById(`iframe-${activeTabIndex}`);
            if (iframe) {
                // This is the "Desktop View" simulation
                // It changes the size, but NOT the User Agent.
                iframe.style.width = isDesktop ? '1280px' : '100%';
                iframe.style.margin = isDesktop ? '0 auto' : '0';
                iframe.style.boxShadow = isDesktop ? '0 0 20px rgba(0,0,0,0.2)' : 'none';
            }
            
            // Update the container padding to center the desktop view
            tabContentContainer.style.padding = isDesktop ? '20px' : '0px';
            tabContentContainer.style.backgroundColor = isDesktop ? '#e5e7eb' : '#fff';
        };


        // --- Initialize ---
        authenticateUser();

    </script>
</body>
</html>
